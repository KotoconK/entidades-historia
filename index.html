<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dos Entidades con Historia y Cotilleos</title>
  <style>
    body { display: flex; font-family: sans-serif; margin: 0; }
    #canvasContainer { flex: 2; }
    #infoPanel { flex: 1; border-left: 2px solid #ccc; padding: 10px; background: #f7f7f7; overflow-y: auto; }
    #log { height: 80vh; overflow-y: auto; border: 1px solid #ddd; padding: 5px; background: #fff; }
  </style>
</head>
<body>
  <div id="canvasContainer"></div>
  <div id="infoPanel">
    <h2>Conversación</h2>
    <div id="log"></div>
    <p><strong>Tiempo:</strong> <span id="time">0</span> s</p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script>
    let A, B, zonas = [], zonaImgs = [];
    let imgA, imgB;
    let tiempo = 0, logDiv;
    let ultimaInteraccion = 0;

    function preload() {
      imgA = loadImage("https://raw.githubusercontent.com/KotoconK/entidades-historia/main/azul.png");
      imgB = loadImage("https://raw.githubusercontent.com/KotoconK/entidades-historia/main/rojo.png");
      zonaImgs[0] = loadImage("https://raw.githubusercontent.com/KotoconK/entidades-historia/main/zona1.png");
      zonaImgs[1] = loadImage("https://raw.githubusercontent.com/KotoconK/entidades-historia/main/zona2.png");
      zonaImgs[2] = loadImage("https://raw.githubusercontent.com/KotoconK/entidades-historia/main/zona3.png");
    }

    function setup() {
      let canvas = createCanvas(600, 400);
      canvas.parent("canvasContainer");
      logDiv = document.getElementById("log");

      A = {x: 100, y: 200, r: 40, memoria: [], mentiras: []};
      B = {x: 500, y: 200, r: 40, memoria: [], mentiras: []};

      zonas = [
        {x:150, y:100, r:30, info:"Conocimiento 1", img: zonaImgs[0]},
        {x:300, y:200, r:30, info:"Conocimiento 2", img: zonaImgs[1]},
        {x:450, y:300, r:30, info:"Conocimiento 3", img: zonaImgs[2]}
      ];

      setInterval(() => {
        tiempo++;
        document.getElementById("time").innerText = tiempo;
      }, 1000);
    }

    function draw() {
      background(230);

      // Dibujar zonas
      for (let z of zonas) image(z.img, z.x - z.r, z.y - z.r, z.r*2, z.r*2);

      mover(A); mover(B);

      image(imgA, A.x - A.r, A.y - A.r, A.r*2, A.r*2);
      image(imgB, B.x - B.r, B.y - B.r, B.r*2, B.r*2);

      // Comprobar recogida de información y añadir log
      for (let z of zonas) {
        if (dist(A.x,A.y,z.x,z.y) < A.r+z.r && !A.memoria.includes(z.info)) {
          A.memoria.push(z.info);
          addLog("A recogió: " + z.info);
        }
        if (dist(B.x,B.y,z.x,z.y) < B.r+z.r && !B.memoria.includes(z.info)) {
          B.memoria.push(z.info);
          addLog("B recogió: " + z.info);
        }
      }

      // Comunicación si están cerca
      if (dist(A.x,A.y,B.x,B.y) < A.r+B.r+20){
        if(millis() - ultimaInteraccion > 3000){ // cada 3 segundos aprox
          ultimaInteraccion = millis();
          comunicarConIA(A,B);
        }
      }
    }

    function mover(ent){
      ent.x += random(-2,2);
      ent.y += random(-2,2);
      ent.x = constrain(ent.x, ent.r, width-ent.r);
      ent.y = constrain(ent.y, ent.r, height-ent.r);
    }

    function addLog(msg){
      let p = document.createElement("p");
      p.textContent = msg;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // --- Backend ChatGPT ---
    async function generarHistoria(prompt){
      const response = await fetch("https://entidades-historia.onrender.com", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({prompt})
      });
      const data = await response.json();
      return data.choices[0].message.content;
    }

    async function comunicarConIA(e1,e2){
      let prompt = `
Dos entidades interactúan.
A sabe: ${e1.memoria.join(", ")}
B sabe: ${e2.memoria.join(", ")}
Genera:
1. Historia oficial
2. Historia con cotilleos y mentiras divertidas
Devuélvelo como texto narrativo.
      `;
      try{
        const historia = await generarHistoria(prompt);
        addLog(historia);
      }catch(e){
        addLog("Error al generar historia: " + e.message);
      }
    }
  </script>
</body>
</html>
