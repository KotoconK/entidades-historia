<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dos Entidades con Historias Dinámicas</title>
  <style>
    body { display: flex; font-family: sans-serif; margin: 0; }
    #canvasContainer { flex: 2; }
    #infoPanel { flex: 1; border-left: 2px solid #ccc; padding: 10px; background: #f7f7f7; overflow-y: auto; }
    #log { height: 50vh; overflow-y: auto; border: 1px solid #ddd; padding: 5px; background: #fff; }
    ul { padding-left: 20px; }
    button { margin-top: 10px; padding: 5px 10px; }
  </style>
</head>
<body>
  <div id="canvasContainer"></div>
  <div id="infoPanel">
    <h2>Conversación</h2>
    <div id="log"></div>
    <p><strong>Tiempo:</strong> <span id="time">0</span> s</p>

    <h3>Memoria de Prudencio</h3>
    <ul id="memoriaA"></ul>

    <h3>Memoria de Juana</h3>
    <ul id="memoriaB"></ul>

    <button onclick="resetMemoria()">Resetear Memoria y Log</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script>
    let A, B;
    let imgA, imgB;
    let zonas = [];
    let zonaImgs = [];
    let tiempo = 0;
    let logDiv;
    const cooldownTime = 60000; // 60 segundos

    // 👉 Cambia esta URL por la de tu backend en Render
    const BACKEND_URL = "https://entidades-historia.onrender.com";

    function preload() {
      imgA = loadImage("https://i.ibb.co/YBZmzKCJ/azul.png");
      imgB = loadImage("https://i.ibb.co/mCDQYhS3/rojo.png");
      zonaImgs[0] = loadImage("https://i.ibb.co/JWm4kK3N/zona1.png");
      zonaImgs[1] = loadImage("https://i.ibb.co/S7ZGq2Y0/zona2.png");
      zonaImgs[2] = loadImage("https://i.ibb.co/5hzpZrr8/zona3.png");
    }

    function setup() {
      let canvas = createCanvas(600, 400);
      canvas.parent("canvasContainer");
      logDiv = document.getElementById("log");

      A = {x:100, y:200, r:40, memoria:[], tx:random(1000), ty:random(1000), cooldown:-cooldownTime, casa:{x:50,y:50}, enCasa:true};
      B = {x:500, y:200, r:40, memoria:[], tx:random(1000), ty:random(1000), cooldown:-cooldownTime, casa:{x:550,y:350}, enCasa:true};

      zonas = [
        { x:150, y:100, r:30, tema:"Disputa entre hermanos por las lindes de la granja", img: zonaImgs[0] },
        { x:300, y:200, r:30, tema:"La hija del panadero y el concurso de pasteles", img: zonaImgs[1] },
        { x:450, y:300, r:30, tema:"El nuevo cura misterioso del pueblo", img: zonaImgs[2] }
      ];

      setInterval(() => {
        tiempo++;
        document.getElementById("time").innerText = tiempo;
      }, 1000);
    }

    function draw() {
      background(230);

      for (let z of zonas) {
        image(z.img, z.x - z.r, z.y - z.r, z.r*2, z.r*2);
      }

      mover(A);
      mover(B);

      image(imgA, A.x - A.r, A.y - A.r, A.r*2, A.r*2);
      image(imgB, B.x - B.r, B.y - B.r, B.r*2, B.r*2);

      recogerFragmentos(A);
      recogerFragmentos(B);

      if (dist(A.x,A.y,B.x,B.y) < A.r + B.r + 20) {
        comunicar(A,B);
      }
    }

    function mover(ent) {
      if(!ent.enCasa){
        let dir = createVector(ent.casa.x - ent.x, ent.casa.y - ent.y);
        if(dir.mag() > 1){
          dir.setMag(2);
          ent.x += dir.x;
          ent.y += dir.y;
        } else {
          ent.enCasa = true;
        }
      } else {
        let dx = map(noise(ent.tx),0,1,-2,2);
        let dy = map(noise(ent.ty),0,1,-2,2);
        ent.x += dx;
        ent.y += dy;
        ent.tx += 0.01;
        ent.ty += 0.01;
        ent.x = constrain(ent.x, ent.r, width - ent.r);
        ent.y = constrain(ent.y, ent.r, height - ent.r);
      }
    }

    async function recogerFragmentos(ent){
      for (let z of zonas){
        if(canCollect(ent, z)){
          try {
            let prompt = `Inventa un fragmento breve de historia relacionado con el tema "${z.tema}". Escríbelo como si fuera un rumor o recuerdo del pueblo.`;
            let fragmento = await generarHistoria(prompt);
            ent.memoria.push(fragmento);
            ent.cooldown = millis();
            ent.enCasa = false;
            addLog((ent===A?"Prudencio":"Juana")+" descubrió: "+fragmento);
            actualizarMemorias();
          } catch(e){
            addLog("Error al generar fragmento: " + e.message);
          }
        }
      }
    }

    function canCollect(ent, z){
      return ent.enCasa && (millis() - ent.cooldown > cooldownTime) && dist(ent.x,ent.y,z.x,z.y)<ent.r+z.r;
    }

    function comunicar(e1,e2){
      if(frameCount % 120 === 0){ // cada ~2 seg
        let nuevaInfo = e1.memoria.filter(f => !e2.memoria.includes(f));
        if(nuevaInfo.length>0){
          e2.memoria = e2.memoria.concat(nuevaInfo);
          addLog("Prudencio le contó a Juana: " + nuevaInfo.join(", "));
          actualizarMemorias();
        } else {
          nuevaInfo = e2.memoria.filter(f => !e1.memoria.includes(f));
          if(nuevaInfo.length>0){
            e1.memoria = e1.memoria.concat(nuevaInfo);
            addLog("Juana le contó a Prudencio: " + nuevaInfo.join(", "));
            actualizarMemorias();
          } else {
            addLog("Juana y Prudencio charlan de banalidades.");
          }
        }
      }
    }

    function actualizarMemorias(){
      let memA = document.getElementById("memoriaA");
      let memB = document.getElementById("memoriaB");
      memA.innerHTML=""; memB.innerHTML="";
      A.memoria.forEach(f => { let li=document.createElement("li"); li.textContent=f; memA.appendChild(li); });
      B.memoria.forEach(f => { let li=document.createElement("li"); li.textContent=f; memB.appendChild(li); });
    }

    function addLog(msg){
      let p=document.createElement("p");
      p.textContent=msg;
      logDiv.appendChild(p);
      logDiv.scrollTop=logDiv.scrollHeight;
    }

    function resetMemoria(){
      A.memoria=[]; B.memoria=[]; logDiv.innerHTML="";
      actualizarMemorias(); tiempo=0; document.getElementById("time").innerText="0";
      A.enCasa=true; B.enCasa=true; A.x=A.casa.x; A.y=A.casa.y; B.x=B.casa.x; B.y=B.casa.y;
    }

    // --- Conexión al backend ---
    async function generarHistoria(prompt){
      const response = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({prompt})
      });
      const data = await response.json();
      return data.choices[0].message.content;
    }
  </script>
</body>
</html>
